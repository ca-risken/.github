name: "Devin PR Review"

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read

jobs:
  devin-pr-review:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && !github.event.pull_request.draft)
    steps:
      - name: Request Devin Code Review
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          JSON_PAYLOAD=$(cat <<EOF
          {
            "prompt": "!security_review :${PR_URL}"
          }
          EOF
          )
          
          echo "ðŸš€ Requesting Devin code review..."
          
          HTTP_STATUS=$(curl -s -w "%{http_code}\n" -o /dev/null -X POST "https://api.devin.ai/v1/sessions" \
               -H "Authorization: Bearer $DEVIN_API_KEY" \
               -H "Content-Type: application/json" \
               -d "$JSON_PAYLOAD")
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "âŒ API request failed with status code: $HTTP_STATUS"
            exit 1
          fi
          
          echo "âœ… Devin session started successfully"
