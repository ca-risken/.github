name: "Devin PR Review"

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  devin-pr-review:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && !github.event.pull_request.draft)
    steps:
      - name: Request Devin Code Review
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
        run: |
          PR_URL="${{ github.event.pull_request.html_url }}"
          
          JSON_PAYLOAD=$(cat <<EOF
          {
            "prompt": "Please review this pull request and look for bugs and security issues. PR: ${PR_URL} Only report on bugs and potential vulnerabilities you find. Be concise. Adapt your response language to match the language used in the PR title and description (e.g., if the PR is written in Japanese, respond in Japanese; if in English, respond in English). After completing the review, make sure to run 'gh pr review -c' to submit your feedback. Execute this command exactly one time - do not repeat if successful."
          }
          EOF
          )
          
          echo "ðŸš€ Requesting Devin code review..."
          
          HTTP_STATUS=$(curl -s -w "%{http_code}\n" -o /dev/null -X POST "https://api.devin.ai/v1/sessions" \
               -H "Authorization: Bearer $DEVIN_API_KEY" \
               -H "Content-Type: application/json" \
               -d "$JSON_PAYLOAD")
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "âŒ API request failed with status code: $HTTP_STATUS"
            exit 1
          fi
          
          echo "âœ… Devin session started successfully"
